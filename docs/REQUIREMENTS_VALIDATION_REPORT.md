# Requirements Validation Report
## Community Social Network MVP - Agentic QE Analysis

**Generated By**: QE Requirements Validator Agent
**Date**: 2025-12-04
**Project**: Serbian Agentics Foundation & StartIT Community Social Network
**Methodology**: INVEST + SMART + BDD Analysis
**Documentation Reviewed**: 9 core documents + 6 research documents

---

## Executive Summary

### Overall Assessment

**Documentation Quality**: ‚≠ê‚≠ê‚≠ê‚≠ê‚òÜ (4.2/5.0)
**Requirements Testability**: ‚≠ê‚≠ê‚≠ê‚≠ê‚òÜ (4.0/5.0)
**Completeness**: ‚≠ê‚≠ê‚≠ê‚≠ê‚òÜ (4.1/5.0)
**Risk Level**: **MEDIUM** (manageable with mitigations)

The Community Social Network MVP documentation demonstrates **strong planning maturity** with comprehensive milestone definitions, clear technical requirements, and well-structured SPARC methodology integration. However, there are **critical gaps** in non-functional requirements, edge case specifications, and acceptance criteria measurability that should be addressed before development.

### Key Findings

‚úÖ **Strengths**:
- Comprehensive milestone breakdown with clear deliverables
- Strong SPARC methodology integration
- Detailed database schema with indexing strategy
- Well-defined API endpoint specifications (~71 endpoints)
- Clear technology stack decisions with rationale
- Excellent dependency mapping and critical path analysis

‚ö†Ô∏è **Critical Gaps Identified**:
- **Missing quantifiable acceptance criteria** in 6 out of 8 milestones
- **Incomplete error handling specifications** across all milestones
- **Insufficient edge case documentation** for complex features
- **Vague non-functional requirements** (scalability, internationalization)
- **Contradictions** between documents on test coverage targets
- **Missing API rate limiting specifications** for most endpoints

üî¥ **High-Risk Areas**:
- **Milestone 3 (Posts & Feed)**: Performance requirements too vague, potential scalability issues
- **Milestone 5 (Groups)**: RBAC complexity underestimated, insufficient permission test scenarios
- **Milestone 7 (Notifications)**: WebSocket scaling requirements unclear, no failover specifications

---

## Milestone-by-Milestone Analysis

### Milestone 1: Foundation & Authentication

**Priority**: CRITICAL
**Testability Score**: 4.5/5.0 ‚≠ê‚≠ê‚≠ê‚≠ê‚òÜ
**Complexity Assessment**: Medium (correctly estimated)
**Duration**: 2 weeks (realistic)

#### INVEST Analysis

| Criterion | Score | Assessment |
|-----------|-------|------------|
| **Independent** | 5/5 | ‚úÖ No external dependencies, true foundation milestone |
| **Negotiable** | 4/5 | ‚ö†Ô∏è JWT implementation is fixed, but email provider is flexible |
| **Valuable** | 5/5 | ‚úÖ Essential user value: secure account access |
| **Estimable** | 5/5 | ‚úÖ Clear 2-week timeline with daily breakdown |
| **Small** | 4/5 | ‚ö†Ô∏è 7 endpoints is achievable but at upper limit for "small" |
| **Testable** | 5/5 | ‚úÖ Clear success criteria: "90%+ coverage, p95 < 200ms" |

**Overall INVEST Score**: 4.7/5.0 ‚úÖ **EXCELLENT**

#### SMART Acceptance Criteria Validation

**Original Criteria**:
> "User can register with email/password"

**Validation**: ‚ùå **INCOMPLETE**
- ‚ùå **Specific**: Lacks password requirements (min length, complexity)
- ‚ùå **Measurable**: No success rate or error rate defined
- ‚úÖ **Achievable**: Technically feasible
- ‚úÖ **Relevant**: Core authentication requirement
- ‚ùå **Time-bound**: No session timeout specified

**Enhanced Criteria**:
```yaml
AC-M1-001: User Registration
  specific:
    - Password: 8+ chars, 1 uppercase, 1 lowercase, 1 number, 1 symbol
    - Email: RFC 5322 compliant format
    - Username: 3-20 chars, alphanumeric + underscore
  measurable:
    - Registration success rate: >99% for valid inputs
    - Response time: p95 < 300ms, p99 < 500ms
    - Invalid input rejection: 100% accuracy
  achievable:
    - bcrypt hashing (12 rounds) for password storage
    - Nodemailer or SendGrid for email delivery
  relevant:
    - Enables user account creation for community participation
  time_bound:
    - Verification token expires after 24 hours
    - Session timeout after 7 days of inactivity
```

#### Gap Analysis

**Missing Specifications**:
1. ‚ùå **Password policy details** (min/max length, complexity rules, blacklist)
2. ‚ùå **Account lockout policy** (mentioned "5 failed attempts" in examples, but not in requirements)
3. ‚ùå **Email verification timeout** (24 hours mentioned in BDD, not in acceptance criteria)
4. ‚ùå **Rate limiting specifics**:
   - Registration: 5 requests/hour per IP (mentioned in checklist)
   - Login: 10 requests/15 min per IP (mentioned in checklist)
   - **NOT** specified: per-account limits, CAPTCHA triggers, unban process
5. ‚ùå **Token rotation policy** (refresh token lifespan, rotation frequency)
6. ‚ùå **GDPR compliance requirements** (data export, deletion, consent)

**Ambiguous Requirements**:
1. ‚ö†Ô∏è "Protected routes reject unauthenticated requests" - What HTTP status code? 401 or 403?
2. ‚ö†Ô∏è "Email verification sends and validates tokens" - Retry logic on email failure?
3. ‚ö†Ô∏è "Rate limiting prevents brute force attacks" - What happens after limit exceeded? Temporary ban? Permanent?

**Contradictions**:
- None identified ‚úÖ

#### Generated BDD Scenarios

```gherkin
Feature: User Registration
  As a new user
  I want to create an account
  So that I can participate in the community

  Background:
    Given the authentication service is running
    And the database is accessible
    And the email service is configured

  Scenario: Successful registration with valid credentials
    Given a new user with email "user@example.com"
    And a strong password "SecurePass123!"
    And username "testuser"
    When the user submits registration form
    Then the system creates user account
    And password is hashed with bcrypt (12 rounds)
    And verification email is sent within 5 seconds
    And verification token expires after 24 hours
    And response status is 201 Created
    And response contains userId and message
    And user cannot login until email is verified

  Scenario: Registration fails with weak password
    Given a new user with email "user@example.com"
    And a weak password "pass"
    When the user submits registration form
    Then registration fails with 400 Bad Request
    And error message is "Password must be 8+ characters with uppercase, lowercase, number, and symbol"
    And no user account is created
    And no email is sent

  Scenario Outline: Registration validation errors
    Given a registration request
    When user submits <email>, <password>, <username>
    Then response status is 400
    And error message is <error_message>

    Examples:
      | email              | password      | username  | error_message                          |
      | invalid-email      | SecurePass1!  | testuser  | "Invalid email format"                 |
      | user@example.com   | short         | testuser  | "Password too short (min 8 chars)"     |
      | user@example.com   | NoNumbers!    | testuser  | "Password must contain number"         |
      | user@example.com   | NoSymbols123  | testuser  | "Password must contain symbol"         |
      | user@example.com   | SecurePass1!  | ab        | "Username too short (min 3 chars)"     |
      | user@example.com   | SecurePass1!  | user@name | "Username must be alphanumeric"        |
      | ""                 | SecurePass1!  | testuser  | "Email is required"                    |
      | user@example.com   | ""            | testuser  | "Password is required"                 |

  Scenario: Duplicate email registration
    Given user "existing@example.com" already exists
    When a new user tries to register with "existing@example.com"
    Then registration fails with 409 Conflict
    And error message is "Email already registered"
    And no duplicate account is created

  Scenario: Rate limiting on registration
    Given 5 registration attempts from IP "192.168.1.100" in the last hour
    When the user makes a 6th registration attempt
    Then request is blocked with 429 Too Many Requests
    And error message is "Registration limit exceeded. Try again in 60 minutes"
    And Retry-After header is set to 3600 seconds

  Scenario: Email delivery failure handling
    Given a valid registration request
    And email service is unavailable
    When the user submits registration form
    Then user account is created
    And verification token is stored
    And registration succeeds with 201 Created
    But email delivery fails silently
    And error is logged for monitoring
    And user receives message "Check your email (may take up to 5 minutes)"
    And email retry job is queued for 5 minutes later

Feature: User Login
  As a registered user
  I want to log into my account
  So that I can access the platform

  Scenario: Successful login with verified email
    Given a verified user with email "user@example.com"
    And correct password "SecurePass123!"
    When the user submits login credentials
    Then authentication succeeds
    And JWT access token is issued (expires in 15 minutes)
    And JWT refresh token is issued (expires in 7 days)
    And tokens are returned in response body
    And response status is 200 OK
    And login event is logged with IP address and timestamp
    And last_login timestamp is updated in database

  Scenario: Login fails with unverified email
    Given an unverified user with email "unverified@example.com"
    And correct password "SecurePass123!"
    When the user submits login credentials
    Then authentication fails with 403 Forbidden
    And error message is "Email not verified. Check your inbox."
    And resend verification link is provided
    And no tokens are issued

  Scenario: Login fails with incorrect password
    Given a verified user with email "user@example.com"
    And incorrect password "WrongPass123"
    When the user submits login credentials
    Then authentication fails with 401 Unauthorized
    And error message is "Invalid credentials"
    And failed login attempt is logged
    And failed_attempts counter is incremented
    And no tokens are issued

  Scenario: Account lockout after 5 failed attempts
    Given a verified user with 4 previous failed login attempts
    When the user submits incorrect password for the 5th time
    Then account is locked for 15 minutes
    And response status is 403 Forbidden
    And error message is "Account locked due to too many failed attempts. Try again in 15 minutes"
    And account_locked_until timestamp is set
    And security alert email is sent to user

  Scenario: Login attempt during account lockout
    Given a user account locked until "2025-12-04T12:30:00Z"
    And current time is "2025-12-04T12:15:00Z" (15 minutes before unlock)
    When the user tries to login
    Then request is rejected with 403 Forbidden
    And error message is "Account locked. Try again in 15 minutes"
    And Retry-After header is set to 900 seconds

  Scenario: Token refresh with valid refresh token
    Given a user with expired access token
    And valid refresh token
    When the user requests token refresh
    Then new access token is issued (expires in 15 minutes)
    And new refresh token is issued (token rotation)
    And old refresh token is invalidated
    And response status is 200 OK

  Scenario: Token refresh fails with invalid token
    Given a user with invalid refresh token
    When the user requests token refresh
    Then request fails with 401 Unauthorized
    And error message is "Invalid refresh token"
    And user must login again

Feature: Email Verification
  As a registered user
  I want to verify my email address
  So that I can access the platform

  Scenario: Successful email verification
    Given a registered user with unverified email
    And a valid verification token "abc123xyz"
    When the user clicks verification link
    Then email is marked as verified
    And verification token is deleted
    And response status is 200 OK
    And user is redirected to login page
    And success message is displayed

  Scenario: Verification fails with expired token
    Given a verification token issued 25 hours ago
    When the user clicks verification link
    Then verification fails with 400 Bad Request
    And error message is "Verification link expired. Request a new one."
    And email remains unverified

  Scenario: Resend verification email
    Given an unverified user with email "user@example.com"
    When the user requests new verification email
    Then old verification token is invalidated
    And new verification token is generated (expires in 24 hours)
    And new verification email is sent
    And response status is 200 OK

Feature: Password Reset
  As a user who forgot their password
  I want to reset it securely
  So that I can regain access to my account

  Scenario: Successful password reset request
    Given a registered user with email "user@example.com"
    When the user requests password reset
    Then reset token is generated (expires in 1 hour)
    And reset email is sent with secure link
    And response status is 200 OK
    And message is "If email exists, reset link has been sent"
    And actual email existence is not disclosed (security)

  Scenario: Password reset with non-existent email
    Given an email "nonexistent@example.com" that doesn't exist
    When the user requests password reset
    Then response status is 200 OK (same as success)
    And message is "If email exists, reset link has been sent"
    And no email is actually sent
    And no token is generated
    And response time is similar to success case (prevent enumeration)

  Scenario: Complete password reset flow
    Given a valid reset token
    And new password "NewSecurePass456!"
    When the user submits new password
    Then password is updated with bcrypt hash
    And reset token is invalidated
    And all refresh tokens are revoked (force re-login)
    And password_changed_at timestamp is updated
    And confirmation email is sent
    And response status is 200 OK

  Scenario: Password reset fails with expired token
    Given a reset token issued 61 minutes ago
    When the user tries to reset password
    Then request fails with 400 Bad Request
    And error message is "Reset link expired. Request a new one."
    And password is not changed

Feature: Protected Routes
  As the system
  I want to secure API endpoints
  So that only authenticated users can access protected resources

  Scenario: Access protected route with valid token
    Given a user with valid JWT access token
    When the user requests "GET /api/users/me"
    Then request succeeds with 200 OK
    And user profile data is returned

  Scenario: Access protected route without token
    Given a user without authentication token
    When the user requests "GET /api/users/me"
    Then request fails with 401 Unauthorized
    And error message is "Authentication required"
    And WWW-Authenticate header includes "Bearer"

  Scenario: Access protected route with expired token
    Given a user with expired JWT access token
    When the user requests "GET /api/users/me"
    Then request fails with 401 Unauthorized
    And error message is "Token expired"
    And client should attempt token refresh

  Scenario: Access admin route with user role
    Given a user with role "user" (not admin)
    When the user requests "GET /api/admin/analytics"
    Then request fails with 403 Forbidden
    And error message is "Insufficient permissions"

  Scenario: Access protected route with malformed token
    Given a malformed JWT token "invalid.token.here"
    When the user requests "GET /api/users/me"
    Then request fails with 401 Unauthorized
    And error message is "Invalid token format"
```

#### Edge Cases Identified

**Boundary Values**:
- ‚úÖ Password length: 8 chars (min), 128 chars (max - should be specified)
- ‚úÖ Username length: 3 chars (min), 20 chars (max)
- ‚úÖ Email length: RFC 5322 max 254 chars
- ‚ùå **MISSING**: Rate limit boundary (exactly 5 attempts, exactly 10 attempts)
- ‚ùå **MISSING**: Token expiration boundary testing (expire exactly at timestamp)

**Concurrent Operations**:
- ‚ùå **MISSING**: Two users register with same email simultaneously (race condition)
- ‚ùå **MISSING**: User attempts multiple logins concurrently (session conflicts)
- ‚ùå **MISSING**: Token refresh during logout (invalidation race)
- ‚ùå **MISSING**: Password reset while user is logged in (security implications)

**Special Characters & Internationalization**:
- ‚ö†Ô∏è Email with plus sign: `user+tag@example.com` (valid but often filtered)
- ‚ö†Ô∏è Email with subdomain: `user@mail.example.com`
- ‚ö†Ô∏è Username with international characters: `Jos√©` or `ÊùéÊòé` (should be supported or explicitly rejected)
- ‚ùå **MISSING**: Password with emoji or non-ASCII characters (security risk?)

**Error Conditions**:
- ‚úÖ Database connection lost during registration
- ‚ö†Ô∏è Redis connection lost (token storage fails - what happens?)
- ‚úÖ Email service timeout (retry logic needed)
- ‚ùå **MISSING**: S3 unavailable (affects profile pictures in M2, but impacts M1 planning)
- ‚ùå **MISSING**: Clock skew between servers (JWT exp validation issues)

#### Risk Assessment

**Technical Risks**:

| Risk | Probability | Impact | Mitigation Status | Severity |
|------|------------|--------|-------------------|----------|
| JWT secret leaked | Low | Critical | ‚ö†Ô∏è Partial: Use env vars, rotation policy not specified | HIGH |
| Bcrypt too slow (DoS) | Medium | High | ‚ùå Missing: No async queue for registration | MEDIUM |
| Email delivery failures | High | Medium | ‚ö†Ô∏è Partial: Retry mentioned, no dead-letter queue | MEDIUM |
| Rate limiting bypassed | Medium | High | ‚ùå Missing: IP spoofing prevention not addressed | HIGH |
| Token storage Redis failure | Medium | Critical | ‚ùå Missing: No Redis failover strategy | HIGH |
| Enumeration attacks | Medium | Medium | ‚ö†Ô∏è Partial: Same response for existing/non-existing emails in password reset | LOW |

**Defect-Prone Requirements**:
1. üî¥ **"Protected routes reject unauthenticated requests"** - Missing spec for token validation order (expired vs invalid vs missing)
2. üî¥ **"Rate limiting prevents brute force"** - Distributed rate limiting (multiple servers) not addressed
3. üü° **"Email verification sends and validates tokens"** - Token collision possibility not addressed (UUID vs random string)

---

### Milestone 2: User Profiles & Media Management

**Priority**: HIGH
**Testability Score**: 3.5/5.0 ‚≠ê‚≠ê‚≠ê‚òÜ‚òÜ
**Complexity Assessment**: Medium (realistic)
**Duration**: 2 weeks (tight but achievable)

#### INVEST Analysis

| Criterion | Score | Assessment |
|-----------|-------|------------|
| **Independent** | 3/5 | ‚ö†Ô∏è Depends on M1 (auth), but logically separate |
| **Negotiable** | 5/5 | ‚úÖ S3 vs MinIO choice explicitly stated |
| **Valuable** | 5/5 | ‚úÖ User identity and personalization |
| **Estimable** | 4/5 | ‚ö†Ô∏è Image optimization complexity may vary |
| **Small** | 4/5 | ‚ö†Ô∏è 5 endpoints + media pipeline is substantial |
| **Testable** | 2/5 | ‚ùå "Profile page loads in <2 seconds" is vague (what data? how many images?) |

**Overall INVEST Score**: 3.8/5.0 ‚ö†Ô∏è **NEEDS IMPROVEMENT**

#### SMART Acceptance Criteria Validation

**Original Criteria**:
> "User can upload and update profile picture"

**Validation**: ‚ùå **INCOMPLETE**
- ‚ùå **Specific**: File type restrictions? Size limits? Dimension requirements?
- ‚ùå **Measurable**: Upload success rate? Processing time?
- ‚ö†Ô∏è **Achievable**: Technically feasible, but CDN setup may delay
- ‚úÖ **Relevant**: Core profile feature
- ‚ùå **Time-bound**: No upload timeout, no retry policy

**Enhanced Criteria**:
```yaml
AC-M2-001: Profile Picture Upload
  specific:
    - Supported formats: JPEG, PNG, WebP
    - Max file size: 5MB (original), 500KB (processed)
    - Min dimensions: 200x200px
    - Max dimensions: 4096x4096px
    - Auto-resize to: 400x400px (large), 128x128px (thumbnail)
    - Compression: WebP with quality 85
  measurable:
    - Upload success rate: >99% for valid files
    - Processing time: p95 < 5 seconds (resize + upload to S3)
    - CDN propagation: <30 seconds globally
    - Image quality score: SSIM >0.90 (structural similarity)
  achievable:
    - Sharp library for image processing (Node.js)
    - AWS S3 or MinIO for storage
    - CloudFront or Cloudflare CDN
  relevant:
    - Enables user identity and visual recognition
  time_bound:
    - Upload timeout: 30 seconds
    - Pre-signed URL expires: 1 hour
    - Retry attempts: 3 with exponential backoff
```

#### Gap Analysis

**Missing Specifications**:
1. ‚ùå **Image optimization strategy**:
   - Lossless vs lossy compression ratio
   - Format conversion rules (PNG ‚Üí WebP, JPEG ‚Üí WebP)
   - Thumbnail generation sizes (missing thumbnail dimensions)
2. ‚ùå **Storage quota management**:
   - Per-user storage limit (mentioned in requirements but no number)
   - What happens when quota exceeded? Hard block? Soft limit?
   - Old image cleanup policy (keep forever? delete after new upload?)
3. ‚ùå **CDN configuration**:
   - Cache TTL for profile images
   - Cache invalidation strategy (on update)
   - Geolocation-based CDN routing
4. ‚ùå **Privacy settings enforcement**:
   - "public/private profiles" mentioned but not detailed
   - What exactly is hidden on private profiles? Just posts? Or profile data too?
   - Can users hide specific profile fields independently?
5. ‚ùå **Profile search requirements**:
   - Full-text search or exact match?
   - Search by username only, or also display name/bio?
   - Search result ranking algorithm
   - Pagination limit (e.g., 50 results max)

**Ambiguous Requirements**:
1. ‚ö†Ô∏è "Images are optimized and served from CDN" - What optimization? Just compression or also format conversion?
2. ‚ö†Ô∏è "Profile updates reflect immediately" - Immediately to user, but what about CDN cache? Eventual consistency acceptable?
3. ‚ö†Ô∏è "Search returns relevant user profiles" - What defines "relevant"? Exact match? Fuzzy search? Popularity score?

**Contradictions**:
- ‚ö†Ô∏è Success criteria says "Profile page loads in <2 seconds" but no baseline data size defined
- ‚ö†Ô∏è "Image upload handles errors gracefully" but no specification of which errors (network? validation? storage?)

#### Generated BDD Scenarios

```gherkin
Feature: Profile Picture Upload
  As a registered user
  I want to upload a profile picture
  So that others can visually identify me

  Background:
    Given the user is authenticated
    And S3 bucket "community-network-profiles" is configured
    And CDN is active with 1-hour cache TTL

  Scenario: Successful profile picture upload (JPEG)
    Given a JPEG image "profile.jpg" of size 2.5MB and dimensions 2000x2000px
    When the user uploads the image as profile picture
    Then image is validated (format, size, dimensions)
    And image is resized to 400x400px (large)
    And thumbnail is generated at 128x128px
    And images are converted to WebP format (quality 85)
    And large image is uploaded to S3 at "profiles/user-{id}/large.webp"
    And thumbnail is uploaded to S3 at "profiles/user-{id}/thumb.webp"
    And CDN URLs are returned in response
    And user profile_picture_url is updated
    And old profile picture is deleted from S3 (if exists)
    And response status is 200 OK
    And upload completes in <5 seconds (p95)

  Scenario: Upload fails with oversized file
    Given a JPEG image of size 6MB (exceeds 5MB limit)
    When the user uploads the image
    Then upload is rejected with 400 Bad Request
    And error message is "File too large. Maximum 5MB allowed."
    And no S3 upload is attempted
    And profile picture is not changed

  Scenario: Upload fails with invalid file type
    Given a GIF image "animated.gif"
    When the user uploads the image
    Then upload is rejected with 400 Bad Request
    And error message is "Invalid file type. Allowed: JPEG, PNG, WebP"
    And no processing is performed

  Scenario: Upload fails with undersized dimensions
    Given a JPEG image of dimensions 150x150px (below 200x200 minimum)
    When the user uploads the image
    Then upload is rejected with 400 Bad Request
    And error message is "Image too small. Minimum 200x200 pixels required."

  Scenario: Concurrent upload handling
    Given the user initiates profile picture upload "image1.jpg"
    And upload is in progress (processing takes 3 seconds)
    When the user initiates second upload "image2.jpg" before first completes
    Then first upload is cancelled
    And second upload proceeds
    And only "image2.jpg" is saved
    And no orphaned S3 objects are left

  Scenario: S3 upload failure handling
    Given a valid image ready for upload
    And S3 service is temporarily unavailable (503)
    When the image is processed and upload attempted
    Then upload is retried 3 times with exponential backoff (1s, 2s, 4s)
    And if all retries fail, error is returned with 503 Service Unavailable
    And error message is "Upload failed. Please try again later."
    And processed images are cleaned up (no temp files left)

  Scenario: CDN cache invalidation on update
    Given user has existing profile picture at CDN URL
    And CDN cache TTL is 1 hour
    When user uploads new profile picture
    Then S3 object is overwritten with new image
    And CDN cache invalidation request is sent
    And new image is accessible via same URL within 30 seconds
    And old cached image is purged globally

Feature: Profile Management
  As a registered user
  I want to manage my profile information
  So that I can present myself to the community

  Scenario: Create complete profile
    Given a newly registered user with only email/username
    When the user creates profile with:
      | Field       | Value                          |
      | displayName | John Doe                       |
      | bio         | Software developer from Serbia |
      | location    | Belgrade, Serbia               |
      | website     | https://johndoe.dev            |
    Then profile is saved to database
    And visibility defaults to "public"
    And response status is 201 Created
    And profile is immediately viewable at /api/users/:id/profile

  Scenario: Update profile with privacy settings
    Given an existing profile with visibility "public"
    When the user updates visibility to "private"
    Then profile visibility is changed to "private"
    And profile is hidden from unauthenticated users
    And profile is hidden from search results
    And only followers can view profile (if following is enabled)
    And response status is 200 OK

  Scenario: Profile validation - bio too long
    Given a bio text of 1500 characters (exceeds limit)
    When the user tries to update profile
    Then update is rejected with 400 Bad Request
    And error message is "Bio too long. Maximum 500 characters allowed."
    And profile is not updated

  Scenario: Profile validation - invalid website URL
    Given a website URL "not-a-valid-url"
    When the user tries to update profile
    Then update is rejected with 400 Bad Request
    And error message is "Invalid website URL format"

Feature: User Search
  As a user
  I want to search for other users
  So that I can find and connect with people

  Scenario: Search by username (exact match)
    Given users exist:
      | Username   | DisplayName | Visibility |
      | johndoe    | John Doe    | public     |
      | janedoe    | Jane Doe    | public     |
      | johndoe123 | John D.     | private    |
    When user searches for "johndoe"
    Then search returns:
      | Username | DisplayName |
      | johndoe  | John Doe    |
    And "johndoe123" is NOT included (private profile)
    And results are sorted by relevance (exact match first)

  Scenario: Search by display name (fuzzy match)
    Given user "johndoe" with display name "John Doe"
    When user searches for "john do" (fuzzy)
    Then search returns "johndoe" as top result
    And result includes profile picture thumbnail
    And result includes bio preview (first 100 chars)

  Scenario: Search pagination
    Given 150 users match search query "test"
    When user searches for "test" with page=1, limit=50
    Then 50 results are returned
    And pagination metadata includes:
      | Field      | Value |
      | total      | 150   |
      | page       | 1     |
      | limit      | 50    |
      | totalPages | 3     |
    And next_page link is provided

  Scenario: Search respects privacy settings
    Given user "privateuser" with visibility "private"
    When unauthenticated user searches for "privateuser"
    Then "privateuser" is NOT included in results
    And no indication of user existence is provided (prevent enumeration)

  Scenario: Search performance under load
    Given 10,000 users in database
    When search query "john" is executed
    Then response time is <300ms (p95)
    And database query uses full-text index
    And results are cached in Redis for 5 minutes
```

#### Edge Cases Identified

**File Upload Edge Cases**:
- ‚ùå **MISSING**: Image with EXIF orientation flag (auto-rotate?)
- ‚ùå **MISSING**: Corrupted image file (partial upload)
- ‚ùå **MISSING**: Image with embedded malicious script (SVG injection)
- ‚ùå **MISSING**: Upload interrupted mid-transfer (resume capability?)
- ‚ö†Ô∏è Image exactly 5.00MB (boundary test)
- ‚ö†Ô∏è Image with dimensions 4096x4096 (max boundary)
- ‚ö†Ô∏è Image with extreme aspect ratio (e.g., 4000x200 - should be rejected?)

**Concurrent Operations**:
- ‚ùå **MISSING**: User updates profile while another user is viewing it (data consistency)
- ‚ùå **MISSING**: Two admins update same user profile simultaneously (last-write-wins?)
- ‚úÖ Addressed: Concurrent image uploads (second cancels first)

**Special Characters**:
- ‚ö†Ô∏è Display name with emoji: "John üöÄ Doe"
- ‚ö†Ô∏è Display name with non-Latin: "–í–ª–∞–¥–∏–º–∏—Ä –ü–µ—Ç—Ä–æ–≤"
- ‚ö†Ô∏è Bio with markdown/HTML: "I love <script>alert('XSS')</script>" (sanitization required)
- ‚ùå **MISSING**: Website URL with non-ASCII domain (IDN punycode)

**Storage Edge Cases**:
- ‚ùå **MISSING**: User deletes account (profile picture cleanup?)
- ‚ùå **MISSING**: S3 storage quota reached (billing alert? hard block?)
- ‚ùå **MISSING**: Orphaned S3 objects (failed upload cleanup)

#### Risk Assessment

| Risk | Probability | Impact | Mitigation Status | Severity |
|------|------------|--------|-------------------|----------|
| Large file uploads DOS | Medium | High | ‚ö†Ô∏è Partial: 5MB limit, no upload rate limit | MEDIUM |
| CDN costs escalate | High | Medium | ‚ùå Missing: No cost monitoring, no upload quota | MEDIUM |
| Malicious file upload | Medium | Critical | ‚ùå Missing: No malware scanning, no file type magic check | HIGH |
| S3 data breach | Low | Critical | ‚ùå Missing: No encryption at rest specification | HIGH |
| Search performance degradation | High | Medium | ‚ö†Ô∏è Partial: Pagination mentioned, no query optimization details | MEDIUM |
| Profile enumeration | Medium | Low | ‚ö†Ô∏è Partial: Private profiles hidden, but existence detectable via 404 vs 403 | LOW |

**Recommendations**:
1. üî¥ **CRITICAL**: Add file type validation using magic bytes (not just extension)
2. üî¥ **CRITICAL**: Specify encryption at rest for S3 (AES-256)
3. üü° **HIGH**: Add malware scanning for uploaded files (ClamAV or third-party API)
4. üü° **HIGH**: Define per-user storage quota (e.g., 100MB total)
5. üü° **HIGH**: Add full-text search index specification (PostgreSQL trgm or Elasticsearch)

---

### Milestone 3: Posts & Content Creation

**Priority**: HIGH
**Testability Score**: 3.0/5.0 ‚≠ê‚≠ê‚≠ê‚òÜ‚òÜ
**Complexity Assessment**: High (correctly identified)
**Duration**: 2-3 weeks (realistic but high variance)

#### INVEST Analysis

| Criterion | Score | Assessment |
|-----------|-------|------------|
| **Independent** | 3/5 | ‚ö†Ô∏è Depends on M1, M2 (auth, media) |
| **Negotiable** | 4/5 | ‚úÖ Feed algorithm flexibility (chronological vs personalized) |
| **Valuable** | 5/5 | ‚úÖ Core value: content sharing |
| **Estimable** | 2/5 | ‚ùå "2-3 weeks" (50% variance) indicates uncertainty |
| **Small** | 2/5 | ‚ùå 12 endpoints + feed algorithm + caching is NOT small |
| **Testable** | 2/5 | ‚ùå "Feed loads in <1.5 seconds" - too vague (how many posts? cached?) |

**Overall INVEST Score**: 3.0/5.0 ‚ö†Ô∏è **NEEDS SIGNIFICANT IMPROVEMENT**

#### SMART Acceptance Criteria Validation

**Original Criteria**:
> "Post creation works with batch image upload, feed loads <1.5s"

**Validation**: ‚ùå **HIGHLY INCOMPLETE**
- ‚ùå **Specific**: Batch upload = how many images? What size? What format?
- ‚ùå **Measurable**: Feed loads <1.5s for how many posts? Cold cache or warm?
- ‚ùå **Achievable**: Unclear if feed performance is realistic without caching strategy
- ‚úÖ **Relevant**: Core feature for content platform
- ‚ùå **Time-bound**: No post creation timeout, no edit window time limit

**Enhanced Criteria**:
```yaml
AC-M3-001: Post Creation with Multiple Images
  specific:
    - Max images per post: 10
    - Supported formats: JPEG, PNG, WebP
    - Max file size per image: 5MB
    - Total post size: 50MB max
    - Image processing: Resize to max 1920x1080, thumbnail 320x240
    - Text content: Max 10,000 characters
    - Visibility options: public, group-only, private
  measurable:
    - Post creation success rate: >99.5% for valid input
    - Creation time: p95 < 3 seconds (text only), p95 < 10 seconds (10 images)
    - Image upload: Parallel processing, all images uploaded within 8 seconds (p95)
    - Edit success rate: >99% within 5 minutes of creation
  achievable:
    - Sharp for image processing (parallel)
    - S3 multipart upload for large files
    - Redis queue for async image processing
  relevant:
    - Enables content creation and sharing
  time_bound:
    - Post draft auto-save: Every 30 seconds
    - Post edit window: 5 minutes after creation
    - Post delete: Soft delete (recoverable for 30 days)
    - Scheduled post: Up to 30 days in future

AC-M3-002: Chronological Feed Performance
  specific:
    - Feed source: All public posts from followed users + own posts
    - Sort order: created_at DESC
    - Pagination: 20 posts per page
    - Cache strategy: User feed cached in Redis (TTL 5 minutes)
    - Cold cache rebuild: Max 50 posts per query
  measurable:
    - Feed load time (warm cache): p95 < 500ms
    - Feed load time (cold cache): p95 < 1500ms
    - Database query time: p95 < 200ms
    - Redis cache hit rate: >80% for active users
    - Feed accuracy: 100% (no missing posts)
  achievable:
    - PostgreSQL index on (author_id, created_at DESC, visibility)
    - Redis hash structure for cached feeds
    - Background job for cache preheating (top 1000 active users)
  relevant:
    - Primary content discovery mechanism
  time_bound:
    - Cache refresh: Every 5 minutes or on new post event
    - Real-time update: New posts appear within 10 seconds
```

#### Gap Analysis

**CRITICAL Missing Specifications**:
1. ‚ùå **Feed algorithm details**:
   - How are posts ranked? Purely chronological or with engagement boost?
   - What if user follows 1000 people? Still chronological?
   - How to handle spam posts (high-frequency posters)?
2. ‚ùå **Reaction system design**:
   - How many reaction types? (like, love, laugh, wow, sad, angry) - 6 mentioned in code, but not in requirements
   - Can user change reaction? (remove + re-add or direct change?)
   - Reaction count consistency (race condition handling)
3. ‚ùå **Post edit policy**:
   - Can posts be edited after comments added? (Facebook allows, Twitter doesn't)
   - Edit history visible? (transparency)
   - Edit notification to users who already interacted?
4. ‚ùå **Draft posts implementation**:
   - Auto-save interval?
   - Draft expiration policy?
   - Max drafts per user?
5. ‚ùå **Scheduled posts**:
   - Max schedule horizon (30 days? 1 year?)
   - Cancellation policy?
   - What if user deletes account before scheduled post?
6. ‚ùå **Share functionality**:
   - Quote share vs direct share?
   - Share to group vs share to timeline?
   - Share privacy implications (can private post be shared?)
7. ‚ùå **Content moderation**:
   - Profanity filter?
   - Spam detection?
   - Manual review queue for flagged posts?

**Ambiguous Requirements**:
1. ‚ö†Ô∏è "Feed pagination performs well (50+ posts)" - Why 50+? What's the max feed size?
2. ‚ö†Ô∏è "Image upload supports batch operations" - Sequential or parallel upload?
3. ‚ö†Ô∏è "Race conditions on like counts" - Eventual consistency acceptable?

**Contradictions**:
- ‚ö†Ô∏è Implementation plan says "Chronological feed (MVP)" but SPARC roadmap mentions "Personalized content feed with chronological algorithm" (which is it?)
- ‚ö†Ô∏è API endpoint summary lists 12 endpoints for Posts, but specification lists only 7-8 (missing share, schedule, draft endpoints?)

#### Generated BDD Scenarios

```gherkin
Feature: Post Creation
  As a user
  I want to create posts with text and images
  So that I can share content with the community

  Background:
    Given the user is authenticated
    And user has active account with email verified

  Scenario: Create text-only post
    Given post content "Hello, community! This is my first post."
    And visibility is "public"
    When the user creates the post
    Then post is saved to database with status "published"
    And post_id is generated (UUID)
    And created_at timestamp is set to current time
    And author_id is set to current user
    And likes_count is initialized to 0
    And comments_count is initialized to 0
    And response status is 201 Created
    And response includes post_id and created_at
    And post appears in author's feed immediately
    And post appears in followers' feeds within 10 seconds (cache refresh)

  Scenario: Create post with 3 images
    Given post content "Check out these amazing photos!"
    And 3 JPEG images: ["photo1.jpg" (2MB), "photo2.jpg" (3MB), "photo3.jpg" (1.5MB)]
    And visibility is "public"
    When the user creates the post
    Then all images are validated (format, size)
    And images are processed in parallel:
      - Resized to max 1920x1080 (preserve aspect ratio)
      - Thumbnails generated at 320x240
      - Converted to WebP (quality 85)
    And images are uploaded to S3 at "posts/{post-id}/image-{index}.webp"
    And thumbnails are uploaded to S3 at "posts/{post-id}/thumb-{index}.webp"
    And post is saved with media_urls array
    And post creation completes in <10 seconds (p95)
    And response status is 201 Created

  Scenario: Post creation fails with too many images
    Given post content "Too many images!"
    And 11 images (exceeds limit of 10)
    When the user tries to create the post
    Then request is rejected with 400 Bad Request
    And error message is "Too many images. Maximum 10 allowed."
    And no post is created
    And no images are uploaded to S3

  Scenario: Post creation fails with oversized content
    Given post content of 15,000 characters (exceeds 10,000 limit)
    When the user tries to create the post
    Then request is rejected with 400 Bad Request
    And error message is "Post too long. Maximum 10,000 characters."

  Scenario: Auto-save draft post
    Given user is composing post "Draft content..."
    And 30 seconds have elapsed since last edit
    When auto-save triggers
    Then draft is saved to database with status "draft"
    And draft_id is returned
    And draft is not visible to other users
    And draft does not appear in feeds

  Scenario: Schedule post for future publication
    Given post content "Scheduled announcement"
    And scheduled_at is set to "2025-12-15T10:00:00Z" (10 days in future)
    When the user creates the post
    Then post is saved with status "scheduled"
    And scheduled_at timestamp is stored
    And post is not visible until scheduled time
    And background job is queued for publication at scheduled time
    And user can edit/cancel scheduled post until publication

  Scenario: Cancel scheduled post
    Given a scheduled post with post_id "123e4567-e89b-12d3-a456-426614174000"
    And scheduled_at is "2025-12-15T10:00:00Z" (5 days in future)
    When the user cancels the scheduled post
    Then post status is changed to "cancelled"
    And background job is removed from queue
    And post is never published

Feature: Post Reactions
  As a user
  I want to react to posts
  So that I can express my feelings about content

  Scenario: Add "like" reaction to post
    Given a post with post_id "abc-123"
    And post has 5 existing likes
    When the user adds "like" reaction
    Then reaction is saved to reactions table
    And likes_count is incremented to 6 (atomic operation)
    And post author receives notification "User X liked your post"
    And response status is 200 OK
    And like appears on post immediately

  Scenario: Change reaction from "like" to "love"
    Given the user previously added "like" reaction to post "abc-123"
    When the user adds "love" reaction to the same post
    Then existing "like" reaction is removed
    And new "love" reaction is added
    And likes_count is decremented by 1
    And loves_count is incremented by 1 (if tracked separately)
    And only one reaction per user per post is enforced (UNIQUE constraint)

  Scenario: Remove reaction
    Given the user has "like" reaction on post "abc-123"
    When the user removes the reaction
    Then reaction is deleted from reactions table
    And likes_count is decremented by 1 (atomic operation)
    And response status is 204 No Content

  Scenario: Concurrent reactions (race condition handling)
    Given a post with likes_count = 100
    And 10 users simultaneously add "like" reaction
    When all reactions are processed
    Then likes_count is exactly 110 (no lost updates)
    And all 10 reactions are saved in reactions table
    And database uses optimistic locking or atomic increment

Feature: Chronological Feed
  As a user
  I want to see recent posts from people I follow
  So that I stay updated with community activity

  Scenario: Load feed (warm cache)
    Given the user follows 50 users
    And feed cache exists in Redis (last updated 2 minutes ago)
    And cache contains 20 most recent posts
    When the user requests feed (page 1, limit 20)
    Then feed is loaded from Redis cache
    And 20 posts are returned in chronological order (newest first)
    And each post includes:
      - post_id, content, media_urls
      - author info (username, display_name, profile_picture)
      - created_at timestamp
      - likes_count, comments_count, shares_count
      - user's reaction (if any)
    And response time is <500ms (p95)
    And response status is 200 OK

  Scenario: Load feed (cold cache)
    Given the user follows 50 users
    And no feed cache exists in Redis
    When the user requests feed (page 1, limit 20)
    Then database query fetches 20 recent posts:
      ```sql
      SELECT p.* FROM posts p
      WHERE p.author_id IN (SELECT following_id FROM follows WHERE follower_id = :user_id)
        AND p.visibility = 'public'
        AND p.status = 'published'
      ORDER BY p.created_at DESC
      LIMIT 20
      ```
    And query uses composite index (author_id, created_at DESC, visibility)
    And results are enriched with author info (JOIN or batch query)
    And feed is cached in Redis with 5-minute TTL
    And response time is <1500ms (p95)
    And response status is 200 OK

  Scenario: Feed pagination
    Given the user's feed contains 100 posts
    When the user requests page 3 with limit 20
    Then posts 41-60 are returned
    And pagination metadata includes:
      | Field      | Value |
      | page       | 3     |
      | limit      | 20    |
      | total      | 100   |
      | hasNext    | true  |
      | hasPrevious| true  |
    And next_page and previous_page links are provided

  Scenario: New post appears in feed (real-time update)
    Given user A follows user B
    And user A has loaded their feed
    When user B creates a new post
    Then user A's feed cache is invalidated (or updated)
    And new post appears in user A's feed within 10 seconds
    And WebSocket event is sent to user A (if connected)

  Scenario: Feed performance with high-frequency poster
    Given user A follows user B
    And user B creates 50 posts per day (high-frequency)
    When user A loads feed
    Then feed is not dominated by user B's posts
    And algorithm may apply throttling (max N posts per user in feed)
    And feed remains diverse with posts from multiple authors

Feature: Post Sharing
  As a user
  I want to share posts I find interesting
  So that my followers can see them too

  Scenario: Share post to timeline
    Given a public post with post_id "abc-123" from user B
    And current user is user A
    When user A shares the post to their timeline
    Then a new "share" record is created:
      - share_id (UUID)
      - sharer_id = user A
      - original_post_id = "abc-123"
      - created_at = current timestamp
    And original post's shares_count is incremented
    And shared post appears in user A's feed (with "user A shared" label)
    And user B receives notification "User A shared your post"
    And response status is 200 OK

  Scenario: Share private post (security violation)
    Given a private post with post_id "xyz-789"
    And current user is not the author
    When user tries to share the post
    Then request is rejected with 403 Forbidden
    And error message is "Cannot share private posts"
    And no share record is created

  Scenario: Share post with comment (quote share)
    Given a public post "abc-123"
    When user shares with comment "This is amazing! üöÄ"
    Then share includes both original post and user's comment
    And comment has max 500 characters
    And share appears as composite post in feed

Feature: Post Editing
  As a user
  I want to edit my posts after publishing
  So that I can correct mistakes

  Scenario: Edit post within 5-minute window
    Given user created post "abc-123" at "2025-12-04T12:00:00Z"
    And current time is "2025-12-04T12:03:00Z" (3 minutes later)
    When user edits post content to "Updated content with correction"
    Then post content is updated
    And updated_at timestamp is set to current time
    And edit_history is recorded (if feature enabled):
      - original_content
      - edited_content
      - edited_at
    And post remains visible in feeds without re-sorting
    And response status is 200 OK

  Scenario: Edit attempt after 5-minute window
    Given user created post "abc-123" at "2025-12-04T12:00:00Z"
    And current time is "2025-12-04T12:06:00Z" (6 minutes later)
    When user tries to edit post
    Then request is rejected with 403 Forbidden
    And error message is "Posts can only be edited within 5 minutes of creation"
    And post content is not changed

  Scenario: Edit post with existing comments
    Given post "abc-123" has 10 comments
    And post is within 5-minute edit window
    When user edits post content
    Then post is updated
    And comments remain associated with post
    And comment authors are NOT notified of edit (privacy consideration)

Feature: Post Deletion
  As a user
  I want to delete my posts
  So that I can remove content I no longer want public

  Scenario: Soft delete post
    Given user created post "abc-123"
    And post has 5 likes and 3 comments
    When user deletes the post
    Then post status is changed to "deleted"
    And post is hidden from feeds immediately
    And post URL returns 404 Not Found
    And post data remains in database for 30 days (soft delete)
    And likes and comments are preserved (for recovery)
    And background job schedules hard delete after 30 days

  Scenario: Restore deleted post within 30 days
    Given post "abc-123" was soft deleted 10 days ago
    When user requests post restoration
    Then post status is changed back to "published"
    And post reappears in feeds
    And likes and comments are restored
    And created_at timestamp remains original (no re-sorting)

  Scenario: Hard delete after 30 days
    Given post "abc-123" was soft deleted 31 days ago
    When background cleanup job runs
    Then post is permanently deleted from database
    And associated media files are deleted from S3
    And likes and comments are cascade deleted
    And post is unrecoverable
```

#### Edge Cases Identified

**Post Content Edge Cases**:
- ‚ùå **MISSING**: Post with only emojis (no text)
- ‚ùå **MISSING**: Post with only whitespace (should be rejected?)
- ‚ùå **MISSING**: Post with XSS payload: `<script>alert('XSS')</script>`
- ‚ùå **MISSING**: Post with SQL injection: `'; DROP TABLE posts;--`
- ‚ùå **MISSING**: Post with extremely long URL (breaks layout?)
- ‚ö†Ô∏è Post with exactly 10,000 characters (boundary test)
- ‚ö†Ô∏è Post with exactly 10 images (boundary test)

**Feed Performance Edge Cases**:
- ‚ùå **MISSING**: User follows 0 people (empty feed handling)
- ‚ùå **MISSING**: User follows 10,000 people (feed query timeout?)
- ‚ùå **MISSING**: All followed users are inactive (no posts in 30 days)
- ‚ùå **MISSING**: Feed contains deleted posts (filter logic)
- ‚ö†Ô∏è Feed cache expired during request (cache stampede)

**Race Conditions**:
- ‚ùå **MISSING**: User deletes post while someone is commenting on it
- ‚ùå **MISSING**: User changes post visibility while someone is sharing it
- ‚ùå **MISSING**: Two users like post simultaneously (duplicate prevention)
- ‚ö†Ô∏è User edits post while another user is reading it (stale data acceptable?)

**Concurrent Upload Edge Cases**:
- ‚ùå **MISSING**: User uploads 10 images, 2 fail, what happens to successful 8?
- ‚ùå **MISSING**: Network interruption during multi-image upload
- ‚ùå **MISSING**: S3 quota reached mid-upload

#### Risk Assessment

| Risk | Probability | Impact | Mitigation Status | Severity |
|------|------------|--------|-------------------|----------|
| Feed performance degradation | HIGH | Critical | ‚ùå Missing: No query optimization details, no load testing plan | CRITICAL |
| Race condition on like counts | HIGH | Medium | ‚ùå Missing: No atomic operation spec, no optimistic locking | HIGH |
| XSS via post content | Medium | Critical | ‚ùå Missing: No input sanitization specification | CRITICAL |
| Cache stampede on feed | Medium | High | ‚ùå Missing: No cache warming or locking strategy | HIGH |
| S3 costs escalate (10 images/post) | HIGH | High | ‚ùå Missing: No cost monitoring, no image optimization validation | HIGH |
| Spam posts flood feed | Medium | High | ‚ùå Missing: No spam detection, no rate limiting on posts | HIGH |
| Deleted post references (orphaned likes/comments) | Medium | Medium | ‚ö†Ô∏è Partial: Soft delete mentioned, cascade delete not detailed | MEDIUM |

**Defect-Prone Requirements**:
1. üî¥ **"Feed loads in <1.5 seconds"** - NO specification for query optimization, indexing strategy, or cache invalidation
2. üî¥ **"Race conditions on like counts"** - Acknowledged but NO solution specified (atomic increment? optimistic locking?)
3. üî¥ **"Image upload supports batch operations"** - No specification for partial failure handling (8 of 10 succeed)

**Recommendations**:
1. üî¥ **CRITICAL**: Add detailed feed query optimization strategy (indexes, materialized views, or denormalization)
2. üî¥ **CRITICAL**: Specify XSS prevention (input sanitization library, CSP headers)
3. üî¥ **CRITICAL**: Define atomic operation strategy for counters (PostgreSQL RETURNING clause or Redis INCR)
4. üü° **HIGH**: Add spam detection requirements (rate limiting: max 10 posts/hour, profanity filter)
5. üü° **HIGH**: Define partial upload failure handling (all-or-nothing vs best-effort)
6. üü° **HIGH**: Add load testing requirements (simulate 1000 users loading feed simultaneously)

---

### Milestone 4: Comments & Nested Discussions

**Priority**: HIGH
**Testability Score**: 3.5/5.0 ‚≠ê‚≠ê‚≠ê‚òÜ‚òÜ
**Complexity Assessment**: Medium-High (accurately estimated)
**Duration**: 2 weeks (realistic)

#### INVEST Analysis

| Criterion | Score | Assessment |
|-----------|-------|------------|
| **Independent** | 3/5 | ‚ö†Ô∏è Depends on M3 (Posts) for content context |
| **Negotiable** | 3/5 | ‚ö†Ô∏è 3-level nesting is fixed (Twitter-like), not negotiable |
| **Valuable** | 5/5 | ‚úÖ Essential for discussions and engagement |
| **Estimable** | 4/5 | ‚úÖ 2 weeks is reasonable for comment system |
| **Small** | 4/5 | ‚ö†Ô∏è 8 endpoints + mention system + nesting logic is substantial |
| **Testable** | 3/5 | ‚ö†Ô∏è "100 comments load <1s" is measurable but lacks cold/warm cache distinction |

**Overall INVEST Score**: 3.7/5.0 ‚ö†Ô∏è **ACCEPTABLE**

#### SMART Acceptance Criteria Validation

**Original Criteria**:
> "Nested replies work up to 3 levels, comment section loads in <1 second for 100 comments"

**Validation**: ‚ö†Ô∏è **PARTIALLY COMPLETE**
- ‚úÖ **Specific**: 3-level nesting is clearly defined
- ‚ö†Ô∏è **Measurable**: Load time specified but query strategy unclear
- ‚úÖ **Achievable**: Materialized path pattern is proven for nested data
- ‚úÖ **Relevant**: Core discussion feature
- ‚ùå **Time-bound**: No comment edit window, no delete policy

**Enhanced Criteria**:
```yaml
AC-M4-001: Nested Comment System
  specific:
    - Max nesting depth: 3 levels (post ‚Üí comment ‚Üí reply ‚Üí reply)
    - Level 0: Top-level comment on post
    - Level 1: Reply to top-level comment
    - Level 2: Reply to level 1 reply
    - Level 3+: Rejected with error
    - Materialized path format: "{parent_path}/{comment_id}"
    - Example: "abc-123/def-456/ghi-789" = level 2 reply
  measurable:
    - Comment creation: p95 < 300ms
    - Comment tree load: p95 < 1000ms for 100 comments
    - Nesting enforcement: 100% accuracy (no level 3+ comments)
    - Query efficiency: Single query retrieves entire tree (no N+1)
  achievable:
    - PostgreSQL recursive CTE for tree traversal
    - Materialized path pattern for efficient querying
    - Index on (post_id, path) for fast lookups
  relevant:
    - Enables threaded discussions
  time_bound:
    - Comment edit window: 5 minutes after creation
    - Comment deletion: Soft delete (mark as [deleted], preserve tree structure)

AC-M4-002: Mention System
  specific:
    - Mention syntax: @username (case-insensitive)
    - Valid mention: Username exists, username starts after space or punctuation
    - Invalid mention: @nonexistent (username doesn't exist) - kept as plain text
    - Max mentions per comment: 10
    - Mention extraction: Regex pattern `@([a-zA-Z0-9_]{3,20})`
  measurable:
    - Mention extraction: 100% accuracy for valid patterns
    - Notification delivery: Within 5 seconds of comment creation
    - Notification failure rate: <1% (with retry)
  achievable:
    - Regex parsing during comment save
    - Lookup username in users table (batch query)
    - Notification queue for async processing
  relevant:
    - Enables direct user interaction in discussions
  time_bound:
    - Notification delivery: Within 5 seconds
    - Mention validation: Synchronous (during comment save)
```

#### Gap Analysis

**Missing Specifications**:
1. ‚ùå **Comment sorting options**:
   - Default sort order: Newest first? Oldest first? Most liked?
   - Can users change sort order? (Reddit-style: top/new/controversial)
2. ‚ùå **Comment pagination strategy**:
   - Load all 100 comments at once? Or paginate replies?
   - "Load more replies" button for deeply nested threads?
3. ‚ùå **Comment moderation**:
   - Can post author delete others' comments? (Yes, mentioned in deliverables)
   - Can post author edit others' comments? (No - should be explicit)
   - What happens to replies when parent is deleted? (cascade? preserve?)
4. ‚ùå **Comment reactions**:
   - Same reaction types as posts? (like, love, laugh, etc.)
   - Reaction count displayed? Sorted by likes?
5. ‚ùå **Edit policy**:
   - Edit history visible?
   - Edited label displayed?
   - Can comments be edited after replies added?
6. ‚ùå **Mention edge cases**:
   - Mention in middle of word: "test@user test" (invalid)
   - Multiple mentions: "@alice @bob check this out" (both notified?)
   - Self-mention: "@own_username" (ignored?)
   - Mention in reply (notification to both mentioned user AND parent author?)

**Ambiguous Requirements**:
1. ‚ö†Ô∏è "Comments load efficiently (no N+1 queries)" - How is tree loaded? Single CTE query? Multiple queries?
2. ‚ö†Ô∏è "Mention system (@username)" - Case-sensitive or case-insensitive?
3. ‚ö†Ô∏è "Real-time comment updates" - WebSocket push or polling? Frequency?

**Contradictions**:
- None identified ‚úÖ

#### Generated BDD Scenarios

```gherkin
Feature: Nested Comment System
  As a user
  I want to reply to comments
  So that I can participate in threaded discussions

  Background:
    Given the user is authenticated
    And a post with post_id "post-123" exists

  Scenario: Add top-level comment (Level 0)
    Given the post has 0 existing comments
    When the user adds comment "Great post! I agree completely."
    Then comment is saved with:
      - comment_id: UUID (generated)
      - post_id: "post-123"
      - author_id: current user
      - parent_comment_id: NULL
      - content: "Great post! I agree completely."
      - path: "comment-123" (root level)
      - depth: 0
      - created_at: current timestamp
    And post's comments_count is incremented to 1
    And post author receives notification "User X commented on your post"
    And response status is 201 Created

  Scenario: Add level 1 reply to top-level comment
    Given a top-level comment "comment-123" with path "comment-123" and depth 0
    When the user replies to "comment-123" with "I have a question about this"
    Then reply is saved with:
      - comment_id: "comment-456"
      - parent_comment_id: "comment-123"
      - path: "comment-123/comment-456" (appends to parent path)
      - depth: 1
    And parent comment's replies_count is incremented
    And parent comment author receives notification "User Y replied to your comment"

  Scenario: Add level 2 reply (deepest allowed)
    Given a level 1 reply "comment-456" with depth 1
    When the user replies to "comment-456"
    Then reply is saved with depth 2
    And path is "comment-123/comment-456/comment-789"
    And response status is 201 Created

  Scenario: Reject level 3 reply (exceeds max depth)
    Given a level 2 reply "comment-789" with depth 2
    When the user tries to reply to "comment-789"
    Then request is rejected with 400 Bad Request
    And error message is "Maximum nesting depth (3 levels) exceeded"
    And no comment is created

  Scenario: Load comment tree for post
    Given a post with 25 comments:
      - 10 top-level comments (depth 0)
      - 10 level 1 replies (depth 1)
      - 5 level 2 replies (depth 2)
    When the user loads comments for the post
    Then all 25 comments are returned in tree structure:
      ```json
      [
        {
          "comment_id": "comment-1",
          "content": "Top-level comment",
          "depth": 0,
          "replies": [
            {
              "comment_id": "comment-2",
              "content": "Reply to comment-1",
              "depth": 1,
              "replies": [
                {
                  "comment_id": "comment-3",
                  "content": "Reply to comment-2",
                  "depth": 2,
                  "replies": []
                }
              ]
            }
          ]
        }
      ]
      ```
    And query uses single recursive CTE (no N+1 problem)
    And response time is <1000ms (p95)

  Scenario: Delete comment with replies (soft delete)
    Given a top-level comment "comment-123" with 5 replies
    When the comment author deletes "comment-123"
    Then comment content is replaced with "[deleted]"
    And comment author is set to NULL
    And replies are preserved (not cascade deleted)
    And comment tree structure remains intact
    And deleted comment still shows "[deleted]" with reply count

  Scenario: Delete comment without replies (hard delete)
    Given a leaf comment "comment-456" with 0 replies
    When the comment author deletes "comment-456"
    Then comment is permanently deleted from database
    And parent comment's replies_count is decremented
    And no orphaned data remains

Feature: Comment Mentions
  As a user
  I want to mention other users in comments
  So that I can get their attention

  Scenario: Mention single user
    Given users exist: @alice, @bob
    When the user adds comment "@alice check out this discussion"
    Then mention is detected and parsed
    And "@alice" is looked up in users table
    And user "alice" receives notification "User X mentioned you in a comment"
    And mention is rendered as clickable link to alice's profile
    And response status is 201 Created

  Scenario: Mention multiple users
    Given users exist: @alice, @bob, @charlie
    When the user adds comment "@alice @bob what do you think? @charlie might know"
    Then all three users receive mention notifications
    And all mentions are rendered as profile links

  Scenario: Mention non-existent user
    Given username "@nonexistent" does not exist
    When the user adds comment "@nonexistent please help"
    Then "@nonexistent" is kept as plain text (not linked)
    And no notification is sent
    And comment is still saved successfully

  Scenario: Mention in middle of word (invalid)
    When the user adds comment "email me at test@user.com"
    Then "@user" is NOT parsed as mention (preceded by alphanumeric)
    And "test@user.com" remains as plain text

  Scenario: Self-mention (ignored)
    Given current user is @alice
    When @alice adds comment "@alice remember to do this"
    Then mention is detected but notification is not sent (self-mention)
    And comment is saved normally

  Scenario: Mention limit exceeded
    Given 11 usernames are mentioned in comment
    When the user tries to create the comment
    Then request is rejected with 400 Bad Request
    And error message is "Too many mentions. Maximum 10 per comment."

  Scenario: Mention in reply (dual notification)
    Given a top-level comment by @bob
    When @alice replies with "@charlie take a look at this"
    Then @charlie receives mention notification
    And @bob receives reply notification (original commenter)
    And both notifications are distinct and clear

Feature: Comment Reactions
  As a user
  I want to react to comments
  So that I can express agreement or emotion

  Scenario: Like a comment
    Given a comment "comment-123" with 3 likes
    When the user adds "like" reaction
    Then reaction is saved (user_id, comment_id, type='like')
    And comment's likes_count is incremented to 4 (atomic)
    And comment author receives notification "User X liked your comment"

  Scenario: Unlike a comment
    Given the user previously liked comment "comment-123"
    When the user removes the like
    Then reaction is deleted
    And likes_count is decremented by 1 (atomic)

Feature: Comment Sorting and Pagination
  As a user
  I want to see comments in preferred order
  So that I can read discussions effectively

  Scenario: Sort comments by newest first (default)
    Given a post with 10 comments created at different times
    When the user loads comments with sort="newest"
    Then comments are sorted by created_at DESC
    And most recent comment appears first

  Scenario: Sort comments by oldest first
    When the user loads comments with sort="oldest"
    Then comments are sorted by created_at ASC
    And oldest comment appears first

  Scenario: Sort comments by most liked
    Given comments have various like counts: [10, 2, 50, 5, 30]
    When the user loads comments with sort="top"
    Then comments are sorted by likes_count DESC
    And comment with 50 likes appears first

  Scenario: Paginate replies
    Given a top-level comment has 50 replies
    When the user expands replies
    Then first 10 replies are loaded
    And "Load more replies (40)" button is displayed
    When the user clicks "Load more"
    Then next 10 replies are loaded

Feature: Comment Editing
  As a user
  I want to edit my comments
  So that I can correct mistakes

  Scenario: Edit comment within 5-minute window
    Given user created comment "comment-123" at "2025-12-04T12:00:00Z"
    And current time is "2025-12-04T12:03:00Z" (3 minutes later)
    When user edits comment to "Corrected content"
    Then comment content is updated
    And updated_at timestamp is set
    And "(edited)" label is displayed
    And response status is 200 OK

  Scenario: Edit attempt after 5-minute window
    Given comment was created 6 minutes ago
    When user tries to edit
    Then request is rejected with 403 Forbidden
    And error message is "Comments can only be edited within 5 minutes"

Feature: Comment Moderation
  As a post author
  I want to moderate comments on my posts
  So that I can maintain healthy discussions

  Scenario: Post author deletes inappropriate comment
    Given a post by @alice
    And a comment by @troll with inappropriate content
    And @alice is logged in
    When @alice deletes @troll's comment
    Then comment is soft deleted (content replaced with "[removed by post author]")
    And @troll is notified of removal (optional, configurable)
    And @troll's replies are preserved

  Scenario: Non-author tries to delete comment
    Given a post by @alice
    And a comment by @bob
    And @charlie (not post author) is logged in
    When @charlie tries to delete @bob's comment
    Then request is rejected with 403 Forbidden
    And error message is "Only post author can delete comments"
```

#### Edge Cases Identified

**Nesting Edge Cases**:
- ‚úÖ Addressed: Level 3+ replies rejected
- ‚ö†Ô∏è Comment tree with 1000 replies to single comment (performance?)
- ‚ùå **MISSING**: Circular reference prevention (comment replies to itself via path manipulation?)
- ‚ùå **MISSING**: Orphaned comments (parent deleted but path still references it)

**Mention Edge Cases**:
- ‚ö†Ô∏è Mention with special characters: `@user_name_123`
- ‚ö†Ô∏è Mention at start of comment: "@alice hello"
- ‚ö†Ô∏è Mention at end of comment: "hello @alice"
- ‚ùå **MISSING**: Mention in edited comment (re-parse mentions? send new notifications?)
- ‚ùå **MISSING**: Mention case sensitivity: @Alice vs @alice
- ‚ùå **MISSING**: Mention with typo: @alic (close to @alice, suggest correction?)

**Concurrent Operations**:
- ‚ùå **MISSING**: Two users reply to same comment simultaneously (ordering?)
- ‚ùå **MISSING**: User deletes comment while someone is replying to it
- ‚ùå **MISSING**: Parent comment deleted while child is being created

**Real-Time Update Edge Cases**:
- ‚ùå **MISSING**: New comment appears while user is reading (UI handling?)
- ‚ùå **MISSING**: Comment deleted while user is replying to it (stale data)

#### Risk Assessment

| Risk | Probability | Impact | Mitigation Status | Severity |
|------|------------|--------|-------------------|----------|
| N+1 query problem on comment trees | Medium | High | ‚úÖ Good: Materialized path + CTE specified | LOW |
| Comment spam (high-frequency commenting) | High | Medium | ‚ùå Missing: No rate limiting on comments | MEDIUM |
| Mention notification spam | Medium | Medium | ‚ö†Ô∏è Partial: 10 mention limit, but no abuse detection | MEDIUM |
| Deleted parent comment orphans replies | Low | Low | ‚ö†Ô∏è Partial: Soft delete preserves tree, but hard delete policy unclear | LOW |
| Real-time update race conditions | Medium | Low | ‚ùå Missing: No conflict resolution strategy | MEDIUM |

**Recommendations**:
1. üü° **MEDIUM**: Add comment rate limiting (e.g., max 30 comments per hour)
2. üü° **MEDIUM**: Specify hard delete policy for orphaned comments (cascade vs preserve)
3. üü° **MEDIUM**: Define mention case-sensitivity (recommend case-insensitive for user experience)
4. üü¢ **LOW**: Add comment spam detection (profanity filter, duplicate comment detection)

---

### Milestone 5: Groups & Communities

**Priority**: CRITICAL
**Testability Score**: 2.5/5.0 ‚≠ê‚≠ê‚òÜ‚òÜ‚òÜ
**Complexity Assessment**: High (accurately identified)
**Duration**: 3 weeks (realistic but optimistic)

#### INVEST Analysis

| Criterion | Score | Assessment |
|-----------|-------|------------|
| **Independent** | 3/5 | ‚ö†Ô∏è Depends on M3 (posts for group content) |
| **Negotiable** | 4/5 | ‚úÖ Privacy levels can be adjusted (2-3 levels) |
| **Valuable** | 5/5 | ‚úÖ Core community feature (primary value prop) |
| **Estimable** | 2/5 | ‚ùå 3 weeks for RBAC + privacy + moderation is ambitious |
| **Small** | 1/5 | ‚ùå 15 endpoints + complex permissions is NOT small |
| **Testable** | 2/5 | ‚ùå "RBAC enforced" is not measurable without test scenarios |

**Overall INVEST Score**: 2.8/5.0 üî¥ **NEEDS MAJOR IMPROVEMENT**

#### SMART Acceptance Criteria Validation

**Original Criteria**:
> "Membership roles are enforced, moderators can manage group content"

**Validation**: ‚ùå **SEVERELY INCOMPLETE**
- ‚ùå **Specific**: What are exact permissions for each role? "Manage content" is vague
- ‚ùå **Measurable**: How to measure "role enforcement"? Permission test count?
- ‚ö†Ô∏è **Achievable**: RBAC is technically feasible but implementation details missing
- ‚úÖ **Relevant**: Essential for group governance
- ‚ùå **Time-bound**: No response time requirements for permission checks

**Enhanced Criteria**:
```yaml
AC-M5-001: Group Role-Based Access Control (RBAC)
  specific:
    roles:
      - owner:
          permissions:
            - Edit group settings (name, description, privacy, cover image)
            - Delete group (irreversible)
            - Promote member to moderator
            - Demote moderator to member
            - Remove any member (except other owners)
            - Approve membership requests (private groups)
            - Pin/unpin posts
            - Delete any post in group
            - View member list with roles
          quantity: Exactly 1 per group (cannot be zero)
          transfer: Owner can transfer ownership to another member
      - moderator:
          permissions:
            - Delete posts in group (not own posts only)
            - Remove members (except owner and other mods)
            - Approve membership requests (private groups)
            - Pin/unpin posts
            - View member list
          quantity: 0-10 per group (configurable)
          promotion: Only owner can promote/demote
      - member:
          permissions:
            - View group (if allowed by privacy)
            - Create posts in group
            - Comment on posts
            - React to posts/comments
            - Leave group
            - View other members
          quantity: Unlimited
          join: Public = auto-join, Private = request approval, Invite-only = must be invited
  measurable:
    - Permission check time: p95 < 10ms (cached in Redis)
    - Permission violation rejection: 100% accuracy
    - Role promotion latency: <500ms (including cache invalidation)
    - Test coverage: 100% of permission matrix (3 roles √ó 20 actions = 60 tests)
  achievable:
    - PostgreSQL group_members table with role column
    - Redis cache for active user permissions (TTL 1 hour)
    - Middleware for permission checks before action execution
  relevant:
    - Enables group governance and moderation
  time_bound:
    - Permission cache TTL: 1 hour (balance between performance and freshness)
    - Role change propagation: Within 5 seconds globally

AC-M5-002: Group Privacy Levels
  specific:
    privacy_levels:
      - public:
          visibility:
            - Group discoverable in search
            - Group feed visible to all users (logged in or anonymous)
            - Member list visible to all
          join_process: Instant (click "Join" ‚Üí member immediately)
      - private:
          visibility:
            - Group discoverable in search
            - Group feed visible only to members
            - Member list visible only to members
          join_process: Request approval (owner/moderator approves)
      - invite-only:
          visibility:
            - Group NOT discoverable in search
            - Group feed visible only to members
            - Member list visible only to members
          join_process: Must receive invitation link from owner/moderator
  measurable:
    - Privacy enforcement: 100% accuracy (no unauthorized access)
    - Join request approval time: p95 < 500ms
    - Privacy violation blocking: 100% (e.g., non-member accessing private feed ‚Üí 403)
  achievable:
    - Middleware checks user membership before serving group content
    - Invitation tokens with expiration (24 hours)
    - Database constraint: group_members UNIQUE(group_id, user_id)
  relevant:
    - Enables private communities and exclusive groups
  time_bound:
    - Invitation link expiration: 24 hours
    - Membership approval: No auto-expire (pending until action)
```

#### Gap Analysis

**CRITICAL Missing Specifications**:
1. ‚ùå **Permission matrix** - MISSING complete permission grid:
   ```
   | Action                     | Owner | Moderator | Member | Non-Member |
   |----------------------------|-------|-----------|--------|------------|
   | View group feed            | ‚úÖ    | ‚úÖ        | ‚úÖ     | Public only |
   | Create post                | ‚úÖ    | ‚úÖ        | ‚úÖ     | ‚ùå         |
   | Delete own post            | ‚úÖ    | ‚úÖ        | ‚úÖ     | ‚ùå         |
   | Delete others' post        | ‚úÖ    | ‚úÖ        | ‚ùå     | ‚ùå         |
   | Edit group settings        | ‚úÖ    | ‚ùå        | ‚ùå     | ‚ùå         |
   | Invite members             | ‚úÖ    | ‚úÖ/?      | ‚ùå/?   | ‚ùå         |
   | Approve join requests      | ‚úÖ    | ‚úÖ        | ‚ùå     | ‚ùå         |
   | Remove member              | ‚úÖ    | ‚úÖ        | ‚ùå     | ‚ùå         |
   | Promote to moderator       | ‚úÖ    | ‚ùå        | ‚ùå     | ‚ùå         |
   | Pin post                   | ‚úÖ    | ‚úÖ        | ‚ùå     | ‚ùå         |
   | View member list           | ‚úÖ    | ‚úÖ        | ‚úÖ     | Public only |
   | Leave group                | ‚ùå    | ‚úÖ        | ‚úÖ     | ‚ùå         |
   | Delete group               | ‚úÖ    | ‚ùå        | ‚ùå     | ‚ùå         |
   ```
   ‚ö†Ô∏è **Many cells are undefined** (marked with `?`)

2. ‚ùå **Group lifecycle management**:
   - What happens when owner leaves/deletes account? (auto-transfer ownership? disband group?)
   - Can group be disbanded with members still in it? (force-leave all?)
   - Archived groups vs deleted groups? (soft delete for recovery?)

3. ‚ùå **Membership request workflow**:
   - Request expiration policy? (pending forever?)
   - Can requester cancel request?
   - Notification to requester on approval/rejection?
   - Can user re-request after rejection?

4. ‚ùå **Invitation system**:
   - Who can invite members? (owner only? moderators? all members?)
   - Invitation link format? (one-time use? multi-use?)
   - Invitation expiration? (24 hours mentioned in enhanced criteria, not in docs)
   - What if invited user is already member?

5. ‚ùå **Group discovery and search**:
   - Search ranking algorithm? (member count? activity? creation date?)
   - Category/tag-based filtering?
   - Recommended groups algorithm?
   - Max groups per user? (prevent spam group creation)

6. ‚ùå **Group moderation tools**:
   - Ban user from group? (prevent re-joining)
   - Mute user temporarily?
   - Content moderation queue for group posts?
   - Audit log of moderator actions?

7. ‚ùå **Group content management**:
   - Pinned posts limit? (e.g., max 3 pinned posts)
   - Pinned post ordering? (manual sort? chronological?)
   - Group announcements vs regular posts? (announcement banner?)
   - Group rules/guidelines enforcement?

**Ambiguous Requirements**:
1. ‚ö†Ô∏è "Group-specific feed" - Does it include only posts directly created in group? Or also shared posts?
2. ‚ö†Ô∏è "Member management" - Can moderators see join/leave history?
3. ‚ö†Ô∏è "Moderator tools" - Can moderators edit group description? Or only delete posts?

**Contradictions**:
- Implementation plan says "Group privacy (public, private, invite-only)" (3 levels)
- Database schema defines privacy as VARCHAR(20) but doesn't specify valid values
- No validation specified for privacy enum

#### Generated BDD Scenarios

```gherkin
Feature: Group Creation
  As a user
  I want to create a group
  So that I can build a community around shared interests

  Background:
    Given the user is authenticated

  Scenario: Create public group
    Given group name "Serbian Agentics Foundation"
    And description "A community for AI and automation enthusiasts in Serbia"
    And privacy is "public"
    And category is "Technology"
    When the user creates the group
    Then group is saved with:
      - group_id: UUID (generated)
      - name: "Serbian Agentics Foundation"
      - privacy: "public"
      - owner_id: current user
      - members_count: 1 (owner auto-joins)
    And group_members entry is created:
      - group_id, user_id (owner)
      - role: "owner"
      - status: "active"
      - joined_at: current timestamp
    And response status is 201 Created
    And group is discoverable in search immediately

  Scenario: Create private group
    When the user creates group with privacy "private"
    Then group is created with privacy "private"
    And group is discoverable in search
    But group feed requires membership
    And join requests require approval

  Scenario: Create invite-only group
    When the user creates group with privacy "invite-only"
    Then group is created with privacy "invite-only"
    And group is NOT discoverable in search
    And only invited users can join

  Scenario: Group name validation - too short
    Given group name "AB" (2 characters)
    When the user tries to create group
    Then request is rejected with 400 Bad Request
    And error message is "Group name too short. Minimum 3 characters."

  Scenario: Group name validation - duplicate
    Given group "Serbian Agentics Foundation" already exists
    When user tries to create group with same name
    Then request is rejected with 409 Conflict
    And error message is "Group name already taken"

Feature: Group Membership - Public Group
  As a user
  I want to join public groups
  So that I can participate in communities

  Scenario: Join public group instantly
    Given a public group "Open Community"
    And user is not a member
    When user clicks "Join Group"
    Then membership is created immediately:
      - role: "member"
      - status: "active"
    And group's members_count is incremented
    And user can access group feed
    And group owner receives notification "User X joined your group"
    And response status is 200 OK

  Scenario: Leave group as member
    Given user is member of group "Open Community"
    When user clicks "Leave Group"
    Then membership is deleted
    And members_count is decremented
    And user can no longer access group feed (if private)
    And response status is 204 No Content

Feature: Group Membership - Private Group
  As a user
  I want to request to join private groups
  So that I can become part of exclusive communities

  Scenario: Request to join private group
    Given a private group "Exclusive Club"
    And user is not a member
    When user clicks "Request to Join"
    Then membership request is created:
      - role: "member"
      - status: "pending"
      - requested_at: current timestamp
    And group owner/moderators receive notification "User X requested to join"
    And user sees "Request Pending" status
    And response status is 200 OK

  Scenario: Owner approves join request
    Given user has pending join request for group "Exclusive Club"
    And current user is group owner
    When owner approves the request
    Then membership status is changed to "active"
    And requester receives notification "Your request to join Exclusive Club was approved"
    And members_count is incremented
    And requester can access group feed

  Scenario: Moderator rejects join request
    Given user has pending join request
    And current user is group moderator
    When moderator rejects the request
    Then membership entry is deleted
    And requester receives notification "Your request to join was declined"
    And requester can request again (no ban)

Feature: Group Membership - Invite-Only
  As a group owner
  I want to invite specific users
  So that I can control membership

  Scenario: Owner generates invitation link
    Given user is owner of invite-only group "Private Network"
    When owner generates invitation link
    Then invitation token is created:
      - token: Random UUID
      - group_id: "Private Network"
      - created_by: owner user_id
      - expires_at: 24 hours from now
      - uses_remaining: 1 (single-use)
    And invitation URL is generated: `/groups/invite/{token}`
    And response status is 200 OK

  Scenario: Invited user joins via link
    Given a valid invitation token for group "Private Network"
    And token is not expired
    When invited user clicks invitation link
    Then user is added to group immediately:
      - role: "member"
      - status: "active"
    And invitation token is marked as used (uses_remaining = 0)
    And user can access group feed
    And group owner receives notification "User X joined via invitation"

  Scenario: Invitation link expired
    Given an invitation token created 25 hours ago (expired)
    When user tries to use the link
    Then request is rejected with 400 Bad Request
    And error message is "Invitation link expired"
    And user is NOT added to group

  Scenario: Invitation link already used
    Given a single-use invitation token
    And token was already used by another user
    When second user tries to use same link
    Then request is rejected with 400 Bad Request
    And error message is "Invitation link already used"

Feature: Group Role-Based Access Control
  As the system
  I want to enforce role permissions
  So that group governance is maintained

  Scenario: Owner edits group settings
    Given user is owner of group "Test Group"
    When owner updates group name to "Updated Group Name"
    Then group name is updated
    And response status is 200 OK

  Scenario: Moderator attempts to edit group settings
    Given user is moderator (not owner) of group "Test Group"
    When moderator tries to update group name
    Then request is rejected with 403 Forbidden
    And error message is "Only group owner can edit settings"
    And group name is not changed

  Scenario: Member attempts to delete post (own post)
    Given user is member of group
    And user created post "post-123" in group
    When user deletes their own post
    Then post is deleted (soft delete)
    And response status is 204 No Content

  Scenario: Member attempts to delete other's post
    Given user is member of group
    And another member created post "post-456"
    When user tries to delete "post-456"
    Then request is rejected with 403 Forbidden
    And error message is "Insufficient permissions to delete this post"

  Scenario: Moderator deletes inappropriate post
    Given user is moderator of group
    And member created post "post-789" with spam content
    When moderator deletes "post-789"
    Then post is soft deleted
    And post author receives notification "Your post was removed by moderator"
    And moderator action is logged in audit trail

  Scenario: Owner promotes member to moderator
    Given user is owner of group
    And another user "alice" is member of group
    When owner promotes "alice" to moderator
    Then "alice"'s role is updated to "moderator"
    And "alice" receives notification "You've been promoted to moderator"
    And "alice"'s permission cache is invalidated (Redis)
    And "alice" can now delete posts

  Scenario: Moderator attempts to promote member (unauthorized)
    Given user is moderator (not owner)
    When moderator tries to promote another member
    Then request is rejected with 403 Forbidden
    And error message is "Only group owner can promote members"

  Scenario: Owner removes member
    Given user is owner of group
    And "bob" is member of group
    When owner removes "bob" from group
    Then "bob"'s membership is deleted
    And "bob" can no longer access group feed (if private)
    And "bob" receives notification "You were removed from the group"
    And members_count is decremented

  Scenario: Member attempts to remove another member
    Given user is member (not moderator)
    When member tries to remove another member
    Then request is rejected with 403 Forbidden

Feature: Group Feed and Posts
  As a group member
  I want to see group-specific posts
  So that I can engage with community content

  Scenario: Load group feed as member
    Given user is member of group "Tech Talk"
    And group has 50 posts
    When user loads group feed (page 1, limit 20)
    Then 20 most recent posts are returned (sorted by created_at DESC)
    And posts are filtered to group_id = "Tech Talk"
    And each post includes author info and engagement metrics
    And response time is <1500ms (p95)

  Scenario: Non-member attempts to view private group feed
    Given user is NOT member of private group "Exclusive Club"
    When user tries to load group feed
    Then request is rejected with 403 Forbidden
    And error message is "You must be a member to view this group"

  Scenario: Anonymous user views public group feed
    Given an unauthenticated user
    And group "Open Community" is public
    When user loads group feed
    Then feed is returned with posts
    And user cannot create posts (must login)

  Scenario: Create post in group
    Given user is member of group "Tech Talk"
    When user creates post "New AI breakthrough!" in group
    Then post is saved with:
      - group_id: "Tech Talk"
      - visibility: "group" (automatically set)
    And post appears in group feed
    And post appears in user's personal feed
    And group members receive notification (if following group)

Feature: Group Moderation Tools
  As a group moderator
  I want to manage content
  So that I can maintain healthy discussions

  Scenario: Pin important post
    Given user is moderator of group
    And post "post-123" is in group
    And 2 posts are already pinned (limit not reached)
    When moderator pins "post-123"
    Then post is marked as pinned (boolean flag)
    And pinned posts appear at top of feed
    And post remains pinned until unpinned

  Scenario: Exceed pinned post limit
    Given 3 posts are already pinned (max limit)
    When moderator tries to pin 4th post
    Then request is rejected with 400 Bad Request
    And error message is "Maximum 3 pinned posts allowed"

  Scenario: Unpin post
    Given post "post-123" is pinned
    When moderator unpins the post
    Then pin flag is removed
    And post returns to chronological position in feed

Feature: Group Discovery and Search
  As a user
  I want to discover groups
  So that I can find communities of interest

  Scenario: Search groups by name
    Given groups exist:
      | Name                  | Privacy | Members |
      | Serbian AI Community  | public  | 150     |
      | Private AI Research   | private | 30      |
      | Secret AI Lab         | invite  | 10      |
    When user searches for "AI"
    Then results include:
      - "Serbian AI Community" (public, discoverable)
      - "Private AI Research" (private, discoverable)
    And results do NOT include "Secret AI Lab" (invite-only, not discoverable)
    And results are sorted by members_count DESC (relevance)

  Scenario: Filter groups by category
    When user filters by category "Technology"
    Then only groups with category "Technology" are returned

  Scenario: View group details as non-member (public)
    Given public group "Open Community"
    When non-member views group page
    Then group name, description, cover image are visible
    And member count is visible
    And recent posts are visible (public feed)
    And "Join Group" button is displayed

  Scenario: View group details as non-member (private)
    Given private group "Exclusive Club"
    When non-member views group page
    Then group name, description, cover image are visible
    And member count is visible
    But recent posts are NOT visible (privacy)
    And "Request to Join" button is displayed
```

#### Edge Cases Identified

**RBAC Edge Cases**:
- ‚ùå **MISSING**: Owner transfers ownership, what happens to their old role? (demoted to member? remain as moderator?)
- ‚ùå **MISSING**: Owner tries to leave group without transferring ownership (blocked? forced transfer?)
- ‚ùå **MISSING**: All moderators leave group, only owner remains (group becomes unmoderated?)
- ‚ùå **MISSING**: Owner deletes account (group orphaned? auto-transfer to oldest moderator?)
- ‚ö†Ô∏è Exactly 10 moderators (boundary test)
- ‚ö†Ô∏è User is owner of 50 groups (spam group creator?)

**Privacy Edge Cases**:
- ‚ùå **MISSING**: Group changes from public to private (what happens to existing non-member viewers?)
- ‚ùå **MISSING**: Group changes from private to public (pending requests auto-approved?)
- ‚ùå **MISSING**: User shares private group post (should be blocked, but how?)

**Membership Edge Cases**:
- ‚ùå **MISSING**: User requests to join, request pending, user tries to request again (duplicate prevention?)
- ‚ùå **MISSING**: User is removed, can they re-join immediately? (cooldown period? permanent ban option?)
- ‚ö†Ô∏è User is member of 100 groups (feed performance impact?)

**Concurrent Operations**:
- ‚ùå **MISSING**: Two moderators delete same post simultaneously (idempotency?)
- ‚ùå **MISSING**: Owner demotes moderator while moderator is deleting a post (permission race condition)
- ‚ùå **MISSING**: User joins group while group is being deleted (timing issue)

#### Risk Assessment

| Risk | Probability | Impact | Mitigation Status | Severity |
|------|------------|--------|-------------------|----------|
| RBAC permission bypass | HIGH | Critical | ‚ùå Missing: No comprehensive permission matrix, no test plan | CRITICAL |
| Group spam (malicious group creation) | High | Medium | ‚ùå Missing: No group creation rate limit, no max groups per user | HIGH |
| Owner account deletion (orphaned groups) | Medium | High | ‚ùå Missing: No ownership transfer policy | HIGH |
| Privacy level change (data leak) | Medium | Critical | ‚ùå Missing: No migration policy for privacy changes | CRITICAL |
| Moderator action abuse | Medium | Medium | ‚ùå Missing: No audit log, no moderator accountability | MEDIUM |
| Invitation link abuse | Medium | Low | ‚ö†Ô∏è Partial: 24-hour expiry, but no rate limit on link generation | MEDIUM |
| Group feed performance degradation | High | High | ‚ö†Ô∏è Partial: Indexing mentioned, but no query optimization details | HIGH |

**Defect-Prone Requirements**:
1. üî¥ **"Membership roles are enforced"** - NO permission matrix, NO test scenarios, NO enforcement strategy
2. üî¥ **"Group privacy controls"** - NO specification for privacy level changes (public‚Üíprivate), data migration unclear
3. üî¥ **"Moderator tools"** - NO audit log requirement, NO accountability, NO abuse prevention
4. üü° **"Private group invitations work"** - Invitation system described but edge cases missing (multi-use? re-invite?)

**Recommendations**:
1. üî¥ **CRITICAL**: Create complete RBAC permission matrix (3 roles √ó 20+ actions = 60+ test cases)
2. üî¥ **CRITICAL**: Define owner account deletion policy (auto-transfer to oldest moderator? disband group?)
3. üî¥ **CRITICAL**: Specify privacy level change migration (public‚Üíprivate: notify members? revoke access?)
4. üü° **HIGH**: Add moderator audit log (all actions logged with timestamp, actor, target)
5. üü° **HIGH**: Add group creation rate limit (max 5 groups per user per day)
6. üü° **HIGH**: Define group lifecycle policy (inactive groups archived after 90 days?)
7. üü° **HIGH**: Add comprehensive RBAC test suite (permissions-test-generator tool)

---

## Summary of Critical Findings

### Top 10 Critical Gaps (Prioritized by Severity)

1. üî¥ **CRITICAL: M5 - Missing RBAC Permission Matrix**
   - **Impact**: Permission bypass vulnerabilities, unauthorized access to group content
   - **Probability**: HIGH (complex permissions always have edge cases)
   - **Recommendation**: Create complete permission grid (60+ test scenarios)

2. üî¥ **CRITICAL: M3 - Feed Performance Requirements Too Vague**
   - **Impact**: Feed timeout under load, poor user experience, potential system outage
   - **Probability**: HIGH (feed queries are notoriously difficult to optimize)
   - **Recommendation**: Define specific indexing strategy, caching policy, query optimization

3. üî¥ **CRITICAL: M5 - Privacy Level Change Policy Missing**
   - **Impact**: Data leak (private content exposed publicly), GDPR violation
   - **Probability**: MEDIUM (privacy changes are rare but high-impact)
   - **Recommendation**: Define migration policy, notification requirements, rollback plan

4. üî¥ **CRITICAL: M3 - XSS Prevention Not Specified**
   - **Impact**: Cross-site scripting attacks, account hijacking, malware distribution
   - **Probability**: MEDIUM (user-generated content is high-risk)
   - **Recommendation**: Specify input sanitization library (DOMPurify), CSP headers, output encoding

5. üî¥ **CRITICAL: M2 - Malicious File Upload Prevention Missing**
   - **Impact**: Malware distribution, server compromise, data breach
   - **Probability**: MEDIUM (file uploads are common attack vector)
   - **Recommendation**: Add file type magic byte validation, malware scanning (ClamAV), S3 encryption at rest

6. üî¥ **CRITICAL: M1 - Rate Limiting Bypass Risk**
   - **Impact**: Brute force attacks, account enumeration, DDoS
   - **Probability**: MEDIUM (rate limiting is frequently bypassed)
   - **Recommendation**: Specify distributed rate limiting (Redis), IP spoofing prevention, CAPTCHA integration

7. üî¥ **CRITICAL: M5 - Owner Account Deletion Policy Missing**
   - **Impact**: Orphaned groups, data loss, broken community
   - **Probability**: LOW (rare but high-impact)
   - **Recommendation**: Auto-transfer ownership to oldest moderator, or disband group with 30-day notice

8. üî¥ **CRITICAL: M3 - Race Condition on Like Counts**
   - **Impact**: Incorrect engagement metrics, database corruption
   - **Probability**: HIGH (concurrent operations are frequent)
   - **Recommendation**: Use PostgreSQL RETURNING clause or Redis INCR for atomic operations

9. üî¥ **CRITICAL: M7 - WebSocket Scaling Requirements Unclear**
   - **Impact**: Real-time feature fails under load, poor user experience
   - **Probability**: MEDIUM (WebSocket scaling is complex)
   - **Recommendation**: Define Socket.io Redis adapter, connection pooling, load balancer sticky sessions

10. üî¥ **CRITICAL: M8 - Admin Access Security Not Specified**
    - **Impact**: Admin account compromise, system-wide breach
    - **Probability**: LOW (admin attacks are targeted)
    - **Recommendation**: Specify 2FA requirement, IP whitelisting, audit logging, session timeout

---

### Document Contradictions Matrix

| Contradiction | Document A | Document B | Severity | Resolution |
|---------------|-----------|-----------|----------|------------|
| Feed algorithm | Implementation Plan: "Chronological feed (MVP)" | SPARC Roadmap: "Personalized content feed with chronological algorithm" | MEDIUM | Clarify: Chronological only, or hybrid? |
| Test coverage targets | M1: 90%, M2-M6: 85%, M7-M8: 80% | Overall: 85% | LOW | Confirm: Overall average or minimum per milestone? |
| API endpoint count | Implementation Plan: "~71 endpoints" | Missing specs for 10+ endpoints | MEDIUM | Audit: Verify all endpoints documented |
| Post edit window | Not specified in M3 requirements | BDD scenarios: 5 minutes | MEDIUM | Confirm: 5 minutes or negotiable? |
| Group moderator limit | Not specified | Enhanced criteria: 0-10 | LOW | Clarify: Is 10 a hard limit or suggestion? |

---

### Testability Scores by Milestone

| Milestone | Testability Score | Status | Key Issues |
|-----------|------------------|--------|------------|
| M1: Auth | 4.5/5.0 ‚≠ê‚≠ê‚≠ê‚≠ê‚òÜ | ‚úÖ EXCELLENT | Clear acceptance criteria, measurable performance targets |
| M2: Profiles | 3.5/5.0 ‚≠ê‚≠ê‚≠ê‚òÜ‚òÜ | ‚ö†Ô∏è GOOD | Missing image optimization specs, CDN config unclear |
| M3: Posts | 3.0/5.0 ‚≠ê‚≠ê‚≠ê‚òÜ‚òÜ | ‚ö†Ô∏è ACCEPTABLE | Feed performance too vague, XSS prevention missing |
| M4: Comments | 3.5/5.0 ‚≠ê‚≠ê‚≠ê‚òÜ‚òÜ | ‚ö†Ô∏è GOOD | Nesting well-defined, but sorting and pagination unclear |
| M5: Groups | 2.5/5.0 ‚≠ê‚≠ê‚òÜ‚òÜ‚òÜ | üî¥ NEEDS WORK | RBAC matrix missing, privacy policy incomplete |
| M6: Social Graph | 3.0/5.0 ‚≠ê‚≠ê‚≠ê‚òÜ‚òÜ | ‚ö†Ô∏è ACCEPTABLE | Follow algorithm unclear, privacy enforcement vague |
| M7: Notifications | 2.5/5.0 ‚≠ê‚≠ê‚òÜ‚òÜ‚òÜ | üî¥ NEEDS WORK | WebSocket scaling unclear, failover strategy missing |
| M8: Admin | 3.0/5.0 ‚≠ê‚≠ê‚≠ê‚òÜ‚òÜ | ‚ö†Ô∏è ACCEPTABLE | Audit log requirements present, but security specs missing |

**Overall Project Testability**: 3.2/5.0 ‚≠ê‚≠ê‚≠ê‚òÜ‚òÜ ‚ö†Ô∏è **ACCEPTABLE** (needs improvement before development)

---

## BDD Scenario Summary

**Total Scenarios Generated**: 142 scenarios across 8 milestones

| Milestone | Features | Scenarios | Coverage |
|-----------|----------|-----------|----------|
| M1: Auth | 7 features | 28 scenarios | Registration, Login, Token Refresh, Verification, Password Reset, Protected Routes, Rate Limiting |
| M2: Profiles | 3 features | 18 scenarios | Picture Upload, Profile CRUD, User Search |
| M3: Posts | 6 features | 32 scenarios | Post Creation, Reactions, Feed, Sharing, Editing, Deletion |
| M4: Comments | 6 features | 24 scenarios | Nested Comments, Mentions, Reactions, Sorting, Editing, Moderation |
| M5: Groups | 7 features | 26 scenarios | Creation, Membership (Public/Private/Invite), RBAC, Feed, Moderation, Discovery |
| M6: Social | 4 features | 8 scenarios | Follow/Unfollow, Block, Privacy, Personalized Feed |
| M7: Notifications | 3 features | 4 scenarios | Real-time, Email, Preferences |
| M8: Admin | 2 features | 2 scenarios | Dashboard, Moderation Queue |

**Note**: M6-M8 scenarios are abbreviated in this report due to length constraints. Full scenario generation recommended.

---

## Prioritized Recommendations

### Immediate Actions (Before Sprint 1)

1. **Complete RBAC Permission Matrix** (M5)
   - Create spreadsheet with all roles √ó actions
   - Generate 60+ permission test scenarios
   - Review with stakeholders for approval
   - **Estimated Effort**: 2 days

2. **Define Feed Query Optimization Strategy** (M3)
   - Specify database indexes (composite, partial)
   - Define Redis caching policy (TTL, invalidation)
   - Plan for materialized views if needed
   - **Estimated Effort**: 1 day

3. **Add Input Sanitization Requirements** (M3, M4)
   - Specify library: DOMPurify for client, validator.js for server
   - Define XSS prevention strategy
   - Add SQL injection prevention (parameterized queries)
   - **Estimated Effort**: 1 day

4. **Enhance Acceptance Criteria** (All Milestones)
   - Convert vague criteria to SMART format
   - Add quantifiable metrics (response time, success rate, coverage)
   - Specify error handling for each endpoint
   - **Estimated Effort**: 3 days

### Short-Term Actions (During Sprint Planning)

5. **Generate Complete BDD Scenario Suite**
   - Expand M6-M8 scenarios (currently abbreviated)
   - Review scenarios with QA team
   - Integrate scenarios into test automation framework
   - **Estimated Effort**: 2 days

6. **Define Rate Limiting Policy** (M1, M3)
   - Specify limits for all endpoints
   - Define distributed rate limiting strategy (Redis)
   - Plan for IP spoofing prevention
   - **Estimated Effort**: 1 day

7. **Add Security Specifications** (M1, M2, M3)
   - Malware scanning for file uploads
   - Encryption at rest (S3, database)
   - 2FA for admin accounts
   - **Estimated Effort**: 2 days

### Medium-Term Actions (During Development)

8. **Create Comprehensive Test Suite**
   - Generate unit tests from BDD scenarios (qe-test-generator)
   - Add edge case tests for each feature
   - Implement load testing for high-risk areas (feed, WebSocket)
   - **Estimated Effort**: Ongoing

9. **Performance Benchmarking**
   - Establish baseline performance metrics
   - Load test critical endpoints (login, feed, notifications)
   - Optimize queries based on test results
   - **Estimated Effort**: 1 day per milestone

10. **Security Auditing**
    - Run OWASP ZAP scans weekly
    - Dependency vulnerability scanning (npm audit)
    - Code review with security focus
    - **Estimated Effort**: 2 hours/week

---

## Conclusion

The Community Social Network MVP documentation demonstrates **strong foundational planning** with clear milestone definitions and SPARC methodology integration. However, **critical gaps** in non-functional requirements, permission specifications, and acceptance criteria measurability pose **significant quality risks**.

**Key Risks**:
- **Milestone 5 (Groups)**: RBAC complexity is underestimated and insufficiently specified
- **Milestone 3 (Posts & Feed)**: Performance requirements are too vague for implementation
- **Security**: Input sanitization, file upload validation, and rate limiting need detailed specs

**Recommended Path Forward**:
1. **Address Critical Gaps** (4 days effort) before Sprint 1
2. **Generate Complete BDD Scenarios** (2 days) for test automation
3. **Implement Comprehensive Test Suite** (ongoing) with 85%+ coverage target
4. **Conduct Weekly Security Audits** (2 hours/week) throughout development
5. **Performance Testing** at end of each milestone to validate requirements

**Overall Readiness**: ‚ö†Ô∏è **CONDITIONAL GO** - Project can proceed with immediate remediation of critical gaps. Recommend 1-week planning sprint to address top 4 recommendations before beginning implementation.

---

**Report Prepared By**: QE Requirements Validator Agent
**Validation Methodology**: INVEST + SMART + BDD Analysis
**Total Requirements Analyzed**: 8 milestones, 71 API endpoints, 142 BDD scenarios
**Risk Assessment**: 25 high-severity risks identified, 10 critical gaps prioritized
**Recommendation**: Address critical gaps before Sprint 1, conditional approval for development

---

**Next Steps**:
1. Review this report with product and technical leads
2. Schedule gap remediation workshop (estimated 1 week)
3. Generate final BDD scenario suite (qe-test-generator)
4. Proceed with Milestone 1 implementation after approval

**Document Version**: 1.0
**Last Updated**: 2025-12-04
**Status**: Final Validation Report - Requires Stakeholder Review
